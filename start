#!/bin/bash
sudo apt remove nodejs -y
sudo apt purge nodejs -y
sudo apt autoremove -y
# Colors
green="\e[38;5;82m"
red="\e[38;5;196m"
neutral="\e[0m"
orange="\e[38;5;130m"
blue="\e[38;5;39m"
yellow="\e[38;5;226m"
purple="\e[38;5;141m"
bold_white="\e[1;37m"
reset="\e[0m"
pink="\e[38;5;205m"
print_rainbow() {
    local text="$1"
    local length=${#text}
    local start_color=(0 5 0)
    local mid_color=(0 200 0)
    local end_color=(0 5 0)

    for ((i = 0; i < length; i++)); do
        local progress=$(echo "scale=2; $i / ($length - 1)" | bc)

        if (($(echo "$progress < 0.5" | bc -l))); then
            local factor=$(echo "scale=2; $progress * 2" | bc)
            r=$(echo "scale=0; (${start_color[0]} * (1-$factor) + ${mid_color[0]} * $factor)/1" | bc)
            g=$(echo "scale=0; (${start_color[1]} * (1-$factor) + ${mid_color[1]} * $factor)/1" | bc)
            b=$(echo "scale=0; (${start_color[2]} * (1-$factor) + ${mid_color[2]} * $factor)/1" | bc)
        else
            local factor=$(echo "scale=2; ($progress - 0.5) * 2" | bc)
            r=$(echo "scale=0; (${mid_color[0]} * (1-$factor) + ${end_color[0]} * $factor)/1" | bc)
            g=$(echo "scale=0; (${mid_color[1]} * (1-$factor) + ${end_color[1]} * $factor)/1" | bc)
            b=$(echo "scale=0; (${mid_color[2]} * (1-$factor) + ${end_color[2]} * $factor)/1" | bc)
        fi

        printf "\e[38;2;%d;%d;%dm%s" "$r" "$g" "$b" "${text:$i:1}"
    done
    echo -e "$reset"
}
cek_status() {
    pm2 status | grep -q sellzivpn && echo "aktif" || echo "nonaktif"
}

setup_bot() {
    timedatectl set-timezone Asia/Jakarta || echo -e "${red}Failed to set timezone to Jakarta${neutral}"

    if ! dpkg -s nodejs >/dev/null 2>&1; then
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - || echo -e "${red}Failed to download Node.js setup${neutral}"
        apt-get install -y nodejs || echo -e "${red}Failed to install Node.js${neutral}"
    else
        echo -e "${green}Node.js is already installed, skipping...${neutral}"
    fi

   rm -rf /root/BotZiVPN

    if [ ! -f /root/BotZiVPN/app.js ]; then
        git clone https://github.com/windrase/BotZiVPN.git /root/BotZiVPN
    fi
apt install jq -y
apt install npm -y
npm install -g npm@latest
npm install -g pm2

    if ! npm list --prefix /root/BotZiVPN express telegraf axios moment sqlite3 >/dev/null 2>&1; then
        npm install --prefix /root/BotZiVPN sqlite3 express crypto telegraf axios dotenv
    fi

    if [ -n "$(ls -A /root/BotZiVPN)" ]; then
        chmod +x /root/BotZiVPN/*
    fi
}

server_app() {
    clear
    echo -e "${orange}─────────────────────────────────────────${neutral}"
    echo -e "   ${green}.:::. BOT sellzivpn TELEGRAM .:::.   ${neutral}"
    echo -e "${orange}─────────────────────────────────────────${neutral}"
    echo -e "       ${green}•${neutral} server create user"
    echo -e "       ${green}•${neutral} server renew user"
    
    echo -e "       ${green}•${neutral} server delete user"
    echo -e "       ${green}•${neutral} server addressel user"
    echo -e "       ${green}•${neutral} server addsaldo user"
    echo -e "       ${green}•${neutral} server ceksaldo user"
    echo -e "${orange}─────────────────────────────────────────${neutral}"
    read -p "Masukkan token bot: " token
    while [ -z "$token" ]; do
        read -p "Masukkan token bot: " token
        if [ -z "$token" ]; then
            echo -e "${red}Token bot tidak boleh kosong. Silakan coba lagi.${neutral}"
        fi
    done
    while [ -z "$adminid" ]; do
        read -p "Masukkan admin ID: " adminid
        if [ -z "$adminid" ]; then
            echo -e "${red}Admin ID tidak boleh kosong. Silakan coba lagi.${neutral}"
        fi
    done
    while [ -z "$namastore" ]; do
        read -p "Masukkan nama store: " namastore
        if [ -z "$namastore" ]; then
            echo -e "${red}Nama store tidak boleh kosong. Silakan coba lagi.${neutral}"
        fi
    done
   while [ -z "$dataqris" ]; do
        read -p "Masukkan DATA QRIS: " dataqris
        if [ -z "$dataqris" ]; then
            echo -e "${red}DATA QRIS tidak boleh kosong. Silakan coba lagi.${neutral}"
        fi
    done
    while [ -z "$auth_username_mutasi" ]; do
        read -p "Masukkan auth_username_mutasi : " auth_username_mutasi
        if [ -z "$auth_username_mutasi" ]; then
            echo -e "${red}auth_username_mutasi tidak boleh kosong. Silakan coba lagi.${neutral}"
        fi
    done
    while [ -z "$auth_token_mutasi" ]; do
        read -p "Masukkan auth_token_mutasi : " auth_token_mutasi
        if [ -z "$auth_token_mutasi" ]; then
            echo -e "${red}auth_token_mutasi tidak boleh kosong. Silakan coba lagi.${neutral}"
        fi
    done
    while [ -z "$auth_paymet_getway" ]; do
        read -p "Masukkan auth_paymet_getway : " auth_paymet_getway
        if [ -z "$auth_paymet_getway" ]; then
            echo -e "${red}auth_paymet_getway tidak boleh kosong. Silakan coba lagi.${neutral}"
        fi
    done
    while [ -z "$web_mutasi" ]; do
        read -p "Masukkan web_mutasi : " web_mutasi
        if [ -z "$web_mutasi" ]; then
            echo -e "${red}web_mutasi tidak boleh kosong. Silakan coba lagi.${neutral}"
        fi
    done
    while [ -z "$groupid" ]; do
        read -p "Masukkan ID GROUP NOTIF : " groupid
        if [ -z "$groupid" ]; then
            echo -e "${red}DATA QRIS tidak boleh kosong. Silakan coba lagi.${neutral}"
        fi
    done
    rm -f /root/BotZiVPN/.vars.json
    echo "{
  \"BOT_TOKEN\": \"$token\",
  \"USER_ID\": \"$adminid\",
  \"NAMA_STORE\": \"$namastore\",
  \"GROUP_ID\": \"$groupid\",
  \"PORT\": \"6969\",
  \"DATA_QRIS\": \"$dataqris\",
  \"auth_username_mutasi\": \"$auth_username_mutasi\",
  \"auth_token_mutasi\": \"$auth_token_mutasi\",
  \"auth_paymet_getway\": \"$auth_paymet_getway\",
  \"web_mutasi\": \"$web_mutasi\"
}" >/root/BotZiVPN/.vars.json

cd /root/BotZiVPN
pm2 start ecosystem.config.js
pm2 startup
pm2 save
cd 

cat >/usr/bin/backup_sellzivpn <<'EOF'
#!/bin/bash
# File: /usr/bin/backup_sellzivpn
# Pastikan chmod +x /usr/bin/backup_sellzivpn

VARS_FILE="/root/BotZiVPN/.vars.json"
DB_FOLDER="/root/BotZiVPN"

# Cek file .vars.json
if [ ! -f "$VARS_FILE" ]; then
    echo "❌ File $VARS_FILE tidak ditemukan"
    exit 1
fi

# Ambil nilai dari .vars.json
BOT_TOKEN=$(jq -r '.BOT_TOKEN' "$VARS_FILE")
USER_ID=$(jq -r '.USER_ID' "$VARS_FILE")

if [ -z "$BOT_TOKEN" ] || [ -z "$USER_ID" ]; then
    echo "❌ BOT_TOKEN atau USER_ID kosong di $VARS_FILE"
    exit 1
fi

# Daftar file database
DB_FILES=("sellzivpn.db" "trial.db" "ressel.db")

for DB_FILE in "${DB_FILES[@]}"; do 
    FILE_PATH="$DB_FOLDER/$DB_FILE"
    if [ -f "$FILE_PATH" ]; then
        curl -s -F chat_id="$USER_ID" \
             -F document=@"$FILE_PATH" \
             "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" >/dev/null 2>&1
        echo "✅ $DB_FILE terkirim ke Telegram"
    else
        echo "❌ File $DB_FILE tidak ditemukan"
    fi
done

echo "✅ Semua backup selesai."
EOF

# bikin cron job tiap jam 12 malam
cat >/etc/cron.d/backup_sellzivpn <<'EOF'
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
0 0 * * * root /usr/bin/backup_sellzivpn
EOF

chmod +x /usr/bin/backup_sellzivpn
chmod +x /usr/bin/sellzivpn
    service cron restart
    printf "\033[5A\033[0J"
    echo -e "       Status Server is "$(cek_status)""
    echo -e "${orange}─────────────────────────────────────────${neutral}"
    echo -e "${green}Bot has been installed and running.${neutral}"
    echo -e "${green}Type ${bold_white}/start${neutral} or ${bold_white}menu${neutral} in the telegram bot${neutral}"
}

if [[ ${1} == "sellzivpn" ]]; then
    setup_bot
    server_app
else
    echo -e "${red}Invalid command. Use: ${yellow}start sellzivpn${neutral}"
    exit 1
fi 
